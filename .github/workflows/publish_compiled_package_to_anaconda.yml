name: Build and Upload Conda Package

on:
  workflow_call:
    inputs:
      python-versions:
        required: true
        type: string
      apt-package:
        required: false
        type: string
      brew-package:
        required: false
        type: string

    secrets:
      ANACONDA_API_TOKEN:
        required: true

jobs:
  conda_deployment:
    name: ${{ matrix.os }} -- Python${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ${{ fromJson(inputs.python-versions) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install APT Package (Linux)
        if: runner.os == 'Linux' && inputs.apt-package != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.apt-package }}

      - name: Install Homebrew Package (macOS)
        if: runner.os == 'macOS' && inputs.brew-package != ''
        run: |
          brew install ${{ inputs.brew-package }}

      - name: Set Up Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: 'latest'
          auto-activate-base: true
          python-version: ${{ matrix.python-version }}
          channels: conda-forge, martinpdes, defaults

      - name: Install Conda Tools
        run: |
          conda install -y anaconda-client conda-build

      - name: Configure Conda Upload
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            conda config --set anaconda_upload true
          else
            conda config --set anaconda_upload false
          fi

      - name: Build and Upload Conda Package
        env:
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}
        run: |
          conda update -n base -c defaults conda
          conda install -y conda-build anaconda-client
          conda remove -n base conda-anaconda-telemetry

          conda build . --python ${{ matrix.python-version }}

          # Only upload on tag push
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            anaconda upload --user martinpdes --token $ANACONDA_API_TOKEN $(conda build . --python ${{ matrix.python-version }} --output)
          fi
